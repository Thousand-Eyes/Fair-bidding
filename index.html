<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>歸零者：熵值平衡協議 (VCG Engine)</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #00ff00;
            --border-color: #00ff00;
            --panel-bg: #111;
            --highlight: #fff;
            --alert: #ff4444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: monospace;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.5;
        }

        h1,
        h2,
        h3 {
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #1a1a1a;
            border-left: 3px solid var(--border-color);
        }

        input,
        select {
            background: #000;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            font-family: monospace;
        }

        button {
            background: var(--text-color);
            color: #000;
            border: none;
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            margin: 5px;
            font-family: monospace;
            border-radius: 2px;
        }

        button:hover {
            background: var(--highlight);
        }

        button.danger {
            background: var(--alert);
            color: #fff;
        }

        button.danger:hover {
            background: #ffaaaa;
            color: #000;
        }

        .hidden {
            display: none !important;
        }

        .log {
            color: #ffaa00;
            font-size: 0.9em;
        }

        .tabs {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .tab {
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .tab.active {
            border: 1px solid var(--border-color);
            border-bottom-color: var(--panel-bg);
            margin-bottom: -1px;
            background: var(--panel-bg);
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }

        .badge {
            background: var(--text-color);
            color: #000;
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <h1>[ 熵值平衡協議 V2.0 ]</h1>

    <!-- Login View -->
    <div id="view-login" class="view panel">
        <h2>身份驗證登入介面</h2>
        <div class="tabs">
            <span class="tab active" onclick="setLoginMode('login')">登入</span>
            <span class="tab" onclick="setLoginMode('register')">註冊</span>
        </div>
        <div>
            <input type="text" id="auth-username" placeholder="請輸入帳號" />
            <br><br>
            <input type="password" id="auth-password" placeholder="請輸入密碼" />
            <br><br>
            <p id="auth-error" style="color:red; display:none;"></p>
            <button id="btn-login" onclick="handleAuth()">執行</button>
        </div>
        <div style="margin-top:20px; font-size:0.8em; color:#666;">
            預設管理員帳號: admin / 密碼: admin
        </div>
    </div>

    <!-- Admin View -->
    <div id="view-admin" class="view hidden">
        <div class="panel" style="display:flex; justify-content:space-between; align-items:center;">
            <h2>管理員控制台 (Admin Node)</h2>
            <button onclick="logout()">登出系統</button>
        </div>

        <div class="panel">
            <h3>節點名單管理 (User Management)</h3>
            <table id="admin-users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名稱</th>
                        <th>帳號</th>
                        <th>密碼</th>
                        <th>餘額(L-Tokens)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="admin-users-list"></tbody>
            </table>
            <br>
            <div style="background:#1a1a1a; padding:10px; border:1px solid #333;">
                <strong>新增或編輯參與者節點:</strong><br><br>
                <input type="hidden" id="edit-user-id" />
                名稱: <input type="text" id="edit-user-name" placeholder="名稱" style="width:100px;" />
                帳號: <input type="text" id="edit-user-account" placeholder="帳號" style="width:100px;" />
                密碼: <input type="text" id="edit-user-password" placeholder="密碼" style="width:100px;" />
                餘額: <input type="number" id="edit-user-balance" placeholder="100" style="width:80px;" />
                <button onclick="saveUser()">儲存</button>
                <button onclick="clearUserEdit()">清除</button>
            </div>
        </div>

        <div class="panel">
            <h3>負效用拍賣場設置 (Bidding Arena)</h3>
            <div style="background:#1a1a1a; padding:10px; border:1px solid #333; margin-bottom:10px;">
                <strong>發布新競標項目:</strong><br><br>
                標題: <input type="text" id="new-task-title" placeholder="例如：清理廁所" style="width:60%;" />
                <button onclick="addTask()">發布項目</button>
            </div>

            <table id="admin-tasks-table">
                <thead>
                    <tr>
                        <th>任務 ID</th>
                        <th>任務標題</th>
                        <th>投標狀況</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="admin-tasks-list"></tbody>
            </table>
            <br>
            <button onclick="settleAllTasks()">一次結算所有項目</button>
        </div>

        <div class="panel">
            <h3>全域事件與競標日誌 (Global Event History)</h3>
            <button class="danger" onclick="clearHistory()" style="margin-bottom:15px;">刪除所有紀錄</button>
            <div class="log" id="admin-history-log"></div>
        </div>
    </div>

    <!-- User View -->
    <div id="view-user" class="view hidden">
        <div class="panel" style="display:flex; justify-content:space-between; align-items:center;">
            <h2>參與者節點 (Participant Node)</h2>
            <div>
                登入身份: <span id="user-name-display" class="badge"></span> |
                餘額: <strong id="user-balance-display">0.00</strong> L-Tokens
                <button onclick="logout()">登出</button>
            </div>
        </div>

        <div class="panel">
            <h3>可投標項目 (Open Bid Items)</h3>
            <p>請為下列任務輸入底價（越低代表越 willing，若得標將獲得補償金）。填寫完畢請點擊下方儲存。<br><span style="color:#666;">※ 留空代表放棄投標（拒絕執行）</span></p>
            <div id="user-bidding-arena"></div>
            <button onclick="submitAllBids()">儲存所有投標</button>
        </div>

        <div class="panel">
            <h3>我的待辦事項 (My Assigned Todos)</h3>
            <div id="user-todo-list"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // State Initialization
        let state = {
            users: [
                { id: 'admin', name: '管理員', account: 'admin', password: 'admin', role: 'admin' }
            ],
            tasks: [], // { id: 't1', title: '...', open: true, bids: { userId: amount } }
            history: [], // { id: 'h1', date: '...', log: '...' }
            currentUser: null
        };

        function loadState() {
            const saved = localStorage.getItem('vcg_state_v2');
            if (saved) {
                state = JSON.parse(saved);
            } else {
                // Default test users
                state.users.push({ id: 'u1', name: '參與者 A', account: 'a', password: '123', role: 'user', balance: 100, todos: [] });
                state.users.push({ id: 'u2', name: '參與者 B', account: 'b', password: '123', role: 'user', balance: 100, todos: [] });
                saveState();
            }
        }

        function saveState() {
            localStorage.setItem('vcg_state_v2', JSON.stringify(state));
        }

        // Add history
        function addHistory(msg) {
            state.history.unshift({
                id: generateId(),
                date: new Date().toLocaleString(),
                log: msg
            });
            saveState();
        }

        // Utilities
        function generateId() { return '_' + Math.random().toString(36).substr(2, 9); }
        function getElement(id) { return document.getElementById(id); }

        // Router
        function render() {
            getElement('view-login').classList.add('hidden');
            getElement('view-admin').classList.add('hidden');
            getElement('view-user').classList.add('hidden');

            if (!state.currentUser) {
                getElement('view-login').classList.remove('hidden');
            } else if (state.currentUser.role === 'admin') {
                getElement('view-admin').classList.remove('hidden');
                renderAdmin();
            } else {
                getElement('view-user').classList.remove('hidden');
                renderUser();
            }
        }

        /* ---------------- Authentication ---------------- */
        let loginMode = 'login';
        function setLoginMode(mode) {
            loginMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            getElement('btn-login').innerText = mode === 'login' ? '登入' : '立即註冊';
        }

        function handleAuth() {
            const acc = getElement('auth-username').value.trim();
            const pwd = getElement('auth-password').value.trim();
            const err = getElement('auth-error');
            err.style.display = 'none';

            if (!acc || !pwd) {
                err.innerText = "帳號密碼不得為空";
                err.style.display = 'block';
                return;
            }

            if (loginMode === 'login') {
                const user = state.users.find(u => u.account === acc && u.password === pwd);
                if (user) {
                    state.currentUser = user;
                    saveState();
                    render();
                } else {
                    err.innerText = "帳號或密碼錯誤";
                    err.style.display = 'block';
                }
            } else {
                if (state.users.find(u => u.account === acc)) {
                    err.innerText = "帳號已註冊過";
                    err.style.display = 'block';
                    return;
                }
                const newUser = {
                    id: generateId(),
                    name: '用戶_' + acc,
                    account: acc,
                    password: pwd,
                    role: 'user',
                    balance: 100,
                    todos: []
                };
                state.users.push(newUser);
                addHistory(`[系統] 新用戶 ${newUser.name} 註冊成功。`);
                state.currentUser = newUser;
                saveState();
                render();
            }
        }

        function logout() {
            state.currentUser = null;
            getElement('auth-username').value = '';
            getElement('auth-password').value = '';
            saveState();
            render();
        }

        /* ---------------- Admin View ---------------- */
        function renderAdmin() {
            // Render Users
            const uList = getElement('admin-users-list');
            uList.innerHTML = state.users.filter(u => u.role === 'user').map(u => `
                <tr>
                    <td>${u.id.slice(0, 6)}</td>
                    <td>${u.name}</td>
                    <td>${u.account}</td>
                    <td>${u.password}</td>
                    <td>${u.balance.toFixed(2)}</td>
                    <td>
                        <button onclick="editUser('${u.id}')">編輯</button>
                        <button class="danger" onclick="deleteUser('${u.id}')">刪除</button>
                    </td>
                </tr>
            `).join('');

            // Render Tasks
            const tList = getElement('admin-tasks-list');
            const openTasks = state.tasks.filter(t => t.open);

            if (openTasks.length === 0) {
                tList.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666;">目前無拍賣中的項目</td></tr>';
            } else {
                tList.innerHTML = openTasks.map(t => {
                    const bidCount = Object.keys(t.bids).length;
                    return `
                    <tr>
                        <td>${t.id.slice(0, 6)}</td>
                        <td>${t.title}</td>
                        <td>${bidCount} 人已投標</td>
                        <td>
                            <button onclick="settleTask('${t.id}')">結算</button>
                            <button class="danger" onclick="deleteTask('${t.id}')">移除</button>
                        </td>
                    </tr>
                `}).join('');
            }

            // Render History
            const hList = getElement('admin-history-log');
            hList.innerHTML = state.history.map(h => `
                <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                    <div style="color:#fff;">[${h.date}]</div>
                    ${h.log.replace(/\\n/g, '<br>')}
                    <br>
                    <button onclick="clearHistory('${h.id}')" class="danger" style="font-size:0.7em; padding:2px 5px; margin-top:8px;">清除此紀錄</button>
                </div>
            `).join('') || '<div style="color:#666;">暫無日誌紀錄</div>';
        }

        // Admin User Management
        function saveUser() {
            const id = getElement('edit-user-id').value;
            const name = getElement('edit-user-name').value.trim();
            const account = getElement('edit-user-account').value.trim();
            const password = getElement('edit-user-password').value.trim();
            const balance = parseFloat(getElement('edit-user-balance').value);

            if (!name || !account || !password || isNaN(balance)) {
                alert("請填寫完整資訊");
                return;
            }

            if (id) {
                const u = state.users.find(u => u.id === id);
                if (u) {
                    u.name = name; u.account = account; u.password = password; u.balance = balance;
                    addHistory(`[系統] 管理員更新參與者 ${u.name}。餘額設為: ${u.balance}`);
                }
            } else {
                if (state.users.find(u => u.account === account)) { alert("該帳號名已存在"); return; }
                const newUser = { id: generateId(), name, account, password, role: 'user', balance, todos: [] };
                state.users.push(newUser);
                addHistory(`[系統] 管理員新增參與者 ${name}。`);
            }
            clearUserEdit();
            saveState();
            renderAdmin();
        }

        function editUser(id) {
            const u = state.users.find(x => x.id === id);
            if (!u) return;
            getElement('edit-user-id').value = u.id;
            getElement('edit-user-name').value = u.name;
            getElement('edit-user-account').value = u.account;
            getElement('edit-user-password').value = u.password;
            getElement('edit-user-balance').value = u.balance;
        }

        function clearUserEdit() {
            ['id', 'name', 'account', 'password', 'balance'].forEach(f => getElement('edit-user-' + f).value = '');
        }

        function deleteUser(id) {
            if (!confirm("確定刪除此參與者？")) return;
            state.users = state.users.filter(u => u.id !== id);
            state.tasks.forEach(t => { if (t.bids[id]) delete t.bids[id]; });
            addHistory(`[系統] 參與者 ID: ${id} 遭管理員抹除。`);
            saveState();
            renderAdmin();
        }

        // Admin Task Management
        function addTask() {
            const title = getElement('new-task-title').value.trim();
            if (!title) return;
            state.tasks.push({ id: generateId(), title, open: true, bids: {} });
            getElement('new-task-title').value = '';
            addHistory(`[系統] 管理員發布新項目: ${title}`);
            saveState();
            renderAdmin();
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveState();
            renderAdmin();
        }

        function clearHistory(id) {
            if (id) {
                state.history = state.history.filter(h => h.id !== id);
            } else {
                if (!confirm("確定清空【所有】日誌？此操作不可逆。")) return;
                state.history = [];
            }
            saveState();
            renderAdmin();
        }

        /* ---------------- VCG Engine Logic ---------------- */
        function settleTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task || !task.open) return;

            const participants = state.users.filter(u => u.role === 'user');
            if (participants.length < 2) {
                alert("至少需要兩名參與者才能進行 VCG 結算。");
                return;
            }

            // Build bids array
            let bidEntries = [];
            for (let user of participants) {
                let bidVal = task.bids[user.id];
                if (bidVal === undefined || bidVal === '') {
                    bidVal = 999999;
                } else {
                    bidVal = parseFloat(bidVal);
                }
                bidEntries.push({ id: user.id, name: user.name, bid: bidVal });
            }

            // Sort ascending -> lowest price wins
            bidEntries.sort((a, b) => a.bid - b.bid);

            let winnerEntry = bidEntries[0];
            let marketEntry = bidEntries[1];
            let clearingPrice = marketEntry.bid;

            if (winnerEntry.bid === 999999) {
                alert(`項目 "${task.title}" 所有人都放棄投標，無法結算。`);
                return;
            }
            if (clearingPrice === 999999) {
                clearingPrice = winnerEntry.bid; // 若只有一人投標，清算價格等於自己的報價
            }

            let losers = bidEntries.slice(1);
            let costPerLoser = losers.length > 0 ? (clearingPrice / losers.length) : 0;

            // Apply balances and assignments
            let actualWinner = state.users.find(u => u.id === winnerEntry.id);
            if (actualWinner) {
                actualWinner.balance += clearingPrice;
                if (!actualWinner.todos) actualWinner.todos = [];
                actualWinner.todos.push({
                    id: generateId(),
                    taskId: task.id,
                    title: task.title,
                    completed: false
                });
            }

            for (let loser of losers) {
                let u = state.users.find(x => x.id === loser.id);
                if (u) u.balance -= costPerLoser;
            }

            task.open = false;

            // Log it
            let report = `[競標結算完成] 項目: ${task.title}\n` +
                `- 得標者：${winnerEntry.name} (原始底價: ${winnerEntry.bid})\n` +
                `- 清算市場價格 P (次低標)：${clearingPrice}\n` +
                `> 得標者獲得 +${clearingPrice.toFixed(2)} L-Tokens，並列入待辦事項！\n` +
                `> 共 ${losers.length} 名其他人平攤價格，每人扣除 -${costPerLoser.toFixed(2)} L-Tokens。`;

            addHistory(report);
            saveState();
            renderAdmin();
        }

        function settleAllTasks() {
            const openTasks = state.tasks.filter(t => t.open);
            if (openTasks.length === 0) {
                alert("目前沒有等待結算的項目。");
                return;
            }
            if (!confirm(`確定要一次結算這 ${openTasks.length} 個項目嗎？`)) return;
            openTasks.forEach(t => settleTask(t.id));
        }

        /* ---------------- User View ---------------- */
        function renderUser() {
            const u = state.users.find(x => x.id === state.currentUser.id);
            if (!u) { logout(); return; }

            getElement('user-name-display').innerText = u.name;
            getElement('user-balance-display').innerText = u.balance.toFixed(2);

            // Bidding Arena
            const openTasks = state.tasks.filter(t => t.open);
            const arena = getElement('user-bidding-arena');
            if (openTasks.length === 0) {
                arena.innerHTML = '<div class="row" style="color:#666; justify-content:center;">目前無開放項目</div>';
            } else {
                arena.innerHTML = openTasks.map(t => {
                    const myBid = t.bids[u.id] !== undefined ? t.bids[u.id] : '';
                    return `
                    <div class="row">
                        <span style="flex:1;">標的: <strong style="color:#fff;">${t.title}</strong></span>
                        <span>我的底價: <input type="number" id="bid_input_${t.id}" value="${myBid}" min="0" style="width:100px;"></span>
                    </div>`;
                }).join('');
            }

            // Todos
            const todoList = getElement('user-todo-list');
            if (!u.todos || u.todos.length === 0) {
                todoList.innerHTML = '<div class="row" style="color:#666; justify-content:center;">無待辦任務。</div>';
            } else {
                const pendingTodos = u.todos.filter(todo => !todo.completed);
                if (pendingTodos.length === 0) {
                    todoList.innerHTML = '<div class="row" style="color:#666; justify-content:center;">任務皆已結案。</div>';
                } else {
                    todoList.innerHTML = pendingTodos.map(todo => `
                    <div class="row" style="border-left-color: #ffaa00;">
                        <span><input type="checkbox" onclick="completeTodo('${todo.id}')" style="margin-right:10px;"> [執行中] ${todo.title}</span>
                    </div>`).join('');
                }
            }
        }

        function submitAllBids() {
            const uId = state.currentUser.id;
            const openTasks = state.tasks.filter(t => t.open);
            openTasks.forEach(t => {
                const el = getElement('bid_input_' + t.id);
                if (el) {
                    const val = el.value.trim();
                    if (val === '') {
                        delete t.bids[uId];
                    } else {
                        t.bids[uId] = parseFloat(val);
                    }
                }
            });
            addHistory(`[節點回報] 參與者 ${state.currentUser.name} 儲存了他的投標設定。`);
            saveState();
            alert("✅ 投標資料更新成功！");
            renderUser();
        }

        function completeTodo(todoId) {
            const u = state.users.find(x => x.id === state.currentUser.id);
            if (u) {
                const target = u.todos.find(t => t.id === todoId);
                if (target) {
                    target.completed = true;
                    addHistory(`[任務達成] ✅ 參與者 ${u.name} 已標記完成任務：${target.title}`);
                    saveState();
                    renderUser();
                }
            }
        }

        // Boot system
        loadState();
        render();

    </script>
</body>

</html>